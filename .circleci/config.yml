# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build:
    machine:
    # Primary container image where all steps run.
      # image: nvcr.io/nvidia/tensorrt:22.01-py3 # does not work with customized image
      # https://circleci.com/docs/2.0/configuration-reference#available-linux-gpu-images
      image: ubuntu-2004-cuda-11.4:202110-01
    resource_class: gpu.nvidia.medium
    steps:
      - checkout
      - run:
          name: set up environment
          command: |
            pip3 install nvidia-pyindex
            pip3 install --upgrade nvidia-tensorrt
            pip3 install --pre torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/nightly/cu113
            pip3 install pytest parameterized expecttest
            
      - run:
          name: install fx2trt
          command: |
            cd py/torch_tensorrt/fx/setup
            python3 setup.py install
            cd ..
      - run:
          name: run tests
          command: |
            cd test/converters/acc_ops
            pytest 
            cd ../../passes
            pytest
            cd ../core
            pytest
            cd ../quant
            pytest
            cd ../tools
            pytest
            cd ../trt_lower
            pytest
            cd ../tracer
            pytest test_acc_shape_prop.py
            pytest test_acc_tracer.py

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  build_setup:
    jobs:
      - build
