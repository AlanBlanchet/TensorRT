# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build:
    machine:
    # Primary container image where all steps run.
      # image: nvcr.io/nvidia/tensorrt:22.01-py3 # does not work with customized image
      # https://circleci.com/docs/2.0/configuration-reference#available-linux-gpu-images
      image: ubuntu-2004-cuda-11.4:202110-01
    resource_class: gpu.nvidia.large
    steps:
      - checkout
      - run:
          name: set up cudnn
          command: |
            cd ~
            OS=ubuntu2004
            wget https://developer.download.nvidia.com/compute/cuda/repos/${OS}/x86_64/cuda-${OS}.pin 
            sudo mv cuda-${OS}.pin /etc/apt/preferences.d/cuda-repository-pin-600
            sudo apt-key adv --fetch-keys https://developer.download.nvidia.com/compute/cuda/repos/${OS}/x86_64/7fa2af80.pub
            sudo add-apt-repository "deb https://developer.download.nvidia.com/compute/cuda/repos/${OS}/x86_64/ /"
            sudo apt-get update
            sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 536F8F1DE80F6A35
            sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys A4B469963BF863CC
            sudo apt-get install libcudnn8=8.2.1.*-1+cuda11.3
            sudo apt-get install libcudnn8-dev=8.2.1.*-1+cuda11.3
      - run:
          name: set up environment
          command: |
            pip3 install nvidia-pyindex
            pip3 install nvidia-tensorrt==8.2.4.2
            pip3 install --pre torch==1.13.0.dev20220618  torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/nightly/cu113
            pip3 install pytest parameterized expecttest
            # install fx2trt
            cd py/torch_tensorrt/fx
            pushd setup
            python3 setup.py install
      - run:
          name: run tests
          command: |
            cd py/torch_tensorrt/fx
            pushd test/converters/acc_op
            pytest 
            popd
            pushd test/passes
            list_passes=$(ls | grep -v test_setitem*) 
            pytest $list_passes
            popd
            pushd test/core
            pytest
            popd
            # pushd test/quant
            # pytest
            # popd
            pushd test/tools
            pytest
            popd
            pushd test/trt_lower
            pytest
            popd
            pushd test/tracer
            list_tracer=$(ls | grep -v test_dispatch_*) 
            pytest $list_tracer
            popd
# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  build_run:
    jobs:
      - build
