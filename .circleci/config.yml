# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build:
    machine:
    # Primary container image where all steps run.
      # image: nvcr.io/nvidia/tensorrt:22.01-py3 # does not work with customized image
      # https://circleci.com/docs/2.0/configuration-reference#available-linux-gpu-images
      image: ubuntu-2004-cuda-11.4:202110-01
    resource_class: gpu.nvidia.large
    steps:
      - checkout
      - run:
          name: set up environment
          command: |
            pip3 install nvidia-pyindex
            pip3 install nvidia-tensorrt==8.2.4.2
            pip3 install --pre torch==1.13.0.dev20220618  torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/nightly/cu113
            pip3 install pytest parameterized expecttest
            
      - run:
          name: install fx2trt
          command: |
            cd py/torch_tensorrt/fx
            pushd setup
            python3 setup.py install
            popd
      - run:
          name: run tests
          command: |
            cd py/torch_tensorrt/fx
            pushd test/converters/acc_op
            pytest 
            popd
            pushd test/passes
            pytest
            popd
            pushd test/core
            pytest
            popd
            pushd test/quant
            pytest
            popd
            pushd test/tools
            pytest
            popd
            pushd test/trt_lower
            pytest
            popd
            pushd test/tracer
            pytest test_acc_shape_prop.py
            pytest test_acc_tracer.py
            popd
# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  build_setup:
    jobs:
      - build
